 <!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Bank Soal Generator (GVIZ)</title>

<style>
body {
  font-family: Arial;
  padding: 20px;
  background: #f4f6f9;
}

table {
  border-collapse: collapse;
  width: 100%;
  background: white;
  margin-top: 15px;
}

th, td {
  border: 1px solid #ddd;
  padding: 8px;
}

th {
  background: #f1f3f4;
}

button {
  padding: 10px 20px;
  background: #1a73e8;
  color: white;
  border: none;
  cursor: pointer;
  border-radius: 4px;
}

button:hover {
  background: #0c5bd3;
}

input[type=text] {
  padding: 8px;
  width: 300px;
}

#loading {
  color: red;
  margin-top: 10px;
}
</style>
</head>

<body>

<h2>Bank Soal (GVIZ)</h2>

<label>Nama File (Form & Doc):</label><br>
<input type="text" id="namaFile" placeholder="Contoh: Ujian Matematika">
<br><br>

<button onclick="generate()">Generate Sekarang</button>

<div id="loading"></div>

<table>
<thead>
<tr>
<th>Pilih</th>
<th>No</th>
<th>Soal</th>
</tr>
</thead>
<tbody id="tbody">
<tr><td colspan="3">Memuat data...</td></tr>
</tbody>
</table>

<script>

// =======================
// GANTI INI
// =======================

const SPREADSHEET_ID = "1R1NU_dTolkdzP_vmoAdsgoP2d0bndLmB28gvFVNsfpE";
const SHEET_NAME = "Sheet1";
const API_URL = "https://script.google.com/macros/s/AKfycby6I8X6RpwAy4r_DpcAWD1NoPjZDlqnZUp4Qy8dMi8eXpIKB19Brd1ap8gl9PeYengdXw/exec";

// =======================
// GVIZ QUERY
// =======================

const query = encodeURIComponent("select * where A is not null");

const url = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?sheet=${SHEET_NAME}&tq=${query}`;

let globalData = [];

fetch(url)
.then(res => res.text())
.then(text => {

  const json = JSON.parse(
    text.substring(47).slice(0, -2)
  );

  const rows = json.table.rows;

  let html = "";
  let index = 0;

  rows.forEach(r => {

    const row = r.c;

    const no = row[0]?.v || "";
    const soal = row[1]?.v || "";

    globalData.push({
      soal: soal,
      A: row[2]?.v || "",
      B: row[3]?.v || "",
      C: row[4]?.v || "",
      D: row[5]?.v || "",
      correct: row[6]?.v || ""
    });

    html += `
      <tr>
        <td><input type="checkbox" value="${index}"></td>
        <td>${no}</td>
        <td>${soal}</td>
      </tr>
    `;

    index++;
  });

  document.getElementById("tbody").innerHTML = html;
})
.catch(err => {
  document.getElementById("tbody").innerHTML =
    "<tr><td colspan='3'>Gagal memuat data</td></tr>";
});

// =======================
// GENERATE FORM + DOC
// =======================

function generate() {

  const namaFile = document.getElementById("namaFile").value.trim();

  if (!namaFile) {
    alert("Isi nama file dulu.");
    return;
  }

  const checked = document.querySelectorAll("input[type=checkbox]:checked");

  if (checked.length === 0) {
    alert("Pilih minimal 1 soal.");
    return;
  }

  const selected = [];

  checked.forEach(cb => {
    selected.push(globalData[parseInt(cb.value)]);
  });

  document.getElementById("loading").innerHTML = "Sedang membuat file...";

  fetch(API_URL + "?action=generateAll"
    + "&namaFile=" + encodeURIComponent(namaFile)
    + "&selected=" + encodeURIComponent(JSON.stringify(selected)))
  .then(res => res.json())
  .then(data => {

    document.getElementById("loading").innerHTML = "";

    if (data.status === "success") {

      alert("Berhasil dibuat!");

      window.open(data.formUrl, "_blank");
      window.open(data.docUrl, "_blank");

    } else {
      alert("Terjadi kesalahan.");
    }

  })
  .catch(err => {
    document.getElementById("loading").innerHTML = "";
    alert("Error koneksi.");
  });
}

</script>

</body>
</html>
