 <!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Bank Soal gn </title>

<style>
body { font-family: Arial; padding: 20px; background:#f4f6f9; }
table { border-collapse: collapse; width:100%; background:white; margin-top:15px; }
th, td { border:1px solid #ddd; padding:8px; }
th { background:#f1f3f4; }
button { padding:10px 20px; background:#1a73e8; color:white; border:none; cursor:pointer; border-radius:4px; }
button:hover { background:#0c5bd3; }
input[type=text] { padding:8px; width:300px; }
#loading { color:red; margin-top:10px; }
.checkbox-cell { text-align: center; }
</style>
</head>

<body>

<h2>Bank Soal (GVIZ + POST)</h2>

<label>Nama File (Form & Doc):</label><br>
<input type="text" id="namaFile" placeholder="Contoh: Ujian Matematika">
<br><br>

<button onclick="generate()">Generate Sekarang</button>
<button onclick="refreshData()" style="background:#34a853; margin-left:10px;">Refresh Data</button>

<div id="loading"></div>

<table>
<thead>
<tr>
<th style="width:50px">Pilih</th>
<th style="width:50px">No</th>
<th>Soal</th>
</tr>
</thead>
<tbody id="tbody">
<tr><td colspan="3" style="text-align:center">Memuat data...</td></tr>
</tbody>
</table>

<script>
// ===============================
// GANTI SESUAI ANDA
// ===============================
const SPREADSHEET_ID = "1R1NU_dTolkdzP_vmoAdsgoP2d0bndLmB28gvFVNsfpE";
const SHEET_NAME = "Sheet1";
// PASTikan URL ini adalah URL DEPLOYMENT Web App yang BENAR
const API_URL = "https://script.google.com/macros/s/AKfycby3ypsxerqC1uYzpjv02O2N9fio7Ci1203rgsqJdcTMEUfF2oO0j7qtQGyJpf4wrxShuw/exec";

let globalData = [];

// ===============================
// LOAD DATA VIA GVIZ
// ===============================
function loadData() {
  const query = encodeURIComponent("select * where A is not null");
  const gvizURL = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?sheet=${SHEET_NAME}&tq=${query}`;
  
  document.getElementById("tbody").innerHTML = "<tr><td colspan='3' style='text-align:center'>Memuat data...</td></tr>";
  
  fetch(gvizURL)
  .then(res => res.text())
  .then(text => {
    // Parse GViz response
    let json;
    try {
      // GViz response format: /*O_o*/ google.visualization.Query.setResponse({...});
      const jsonText = text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1);
      json = JSON.parse(jsonText);
    } catch (e) {
      throw new Error("Gagal parse data dari spreadsheet");
    }
    
    if (!json.table || !json.table.rows) {
      throw new Error("Tidak ada data di spreadsheet");
    }
    
    const rows = json.table.rows;
    let html = "";
    globalData = [];

    rows.forEach((r, idx) => {
      const row = r.c;
      
      // Handle jika cell null
      const no = (row && row[0] && row[0].v) ? row[0].v : (idx + 1);
      const soal = (row && row[1] && row[1].v) ? row[1].v : "";
      const A = (row && row[2] && row[2].v) ? row[2].v : "";
      const B = (row && row[3] && row[3].v) ? row[3].v : "";
      const C = (row && row[4] && row[4].v) ? row[4].v : "";
      const D = (row && row[5] && row[5].v) ? row[5].v : "";
      const correct = (row && row[6] && row[6].v) ? row[6].v : "";

      // Skip jika tidak ada soal
      if (!soal) return;

      globalData.push({
        soal: soal,
        A: A,
        B: B,
        C: C,
        D: D,
        correct: correct
      });

      html += `
        <tr>
          <td class="checkbox-cell"><input type="checkbox" value="${globalData.length - 1}"></td>
          <td>${no}</td>
          <td>${soal.substring(0, 100)}${soal.length > 100 ? '...' : ''}</td>
        </tr>
      `;
    });

    if (globalData.length === 0) {
      html = "<tr><td colspan='3' style='text-align:center'>Tidak ada data soal</td></tr>";
    }

    document.getElementById("tbody").innerHTML = html;
  })
  .catch(err => {
    console.error(err);
    document.getElementById("tbody").innerHTML = 
      "<tr><td colspan='3' style='text-align:center; color:red'>Gagal memuat data: " + err.message + "</td></tr>";
  });
}

// ===============================
// GENERATE (POST SAFE)
// ===============================
function generate() {
  const namaFile = document.getElementById("namaFile").value.trim();

  if (!namaFile) {
    alert("Isi nama file terlebih dahulu.");
    return;
  }

  const checkboxes = document.querySelectorAll("input[type=checkbox]:checked");
  
  if (checkboxes.length === 0) {
    alert("Pilih minimal 1 soal.");
    return;
  }

  const selected = [];
  checkboxes.forEach(cb => {
    const index = parseInt(cb.value);
    if (globalData[index]) {
      selected.push(globalData[index]);
    }
  });

  if (selected.length === 0) {
    alert("Data soal tidak valid");
    return;
  }

  document.getElementById("loading").innerHTML = "Sedang membuat file...";
  document.querySelector("button").disabled = true;

  // Test koneksi dulu
  fetch(API_URL + "?test=1", {
    method: "GET",
    mode: "cors"
  })
  .then(res => res.json())
  .then(testData => {
    // Koneksi OK, lanjut POST
    return fetch(API_URL, {
      method: "POST",
      mode: "cors",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        namaFile: namaFile,
        selected: selected
      })
    });
  })
  .then(res => res.json())
  .then(data => {
    document.getElementById("loading").innerHTML = "";
    document.querySelector("button").disabled = false;

    if (data.status === "success") {
      alert("Berhasil dibuat!");
      window.open(data.formUrl, "_blank");
      window.open(data.docUrl, "_blank");
      
      // Reset checkbox
      document.querySelectorAll("input[type=checkbox]").forEach(cb => cb.checked = false);
      document.getElementById("namaFile").value = "";
    } else {
      alert("Error: " + data.message);
    }
  })
  .catch(err => {
    document.getElementById("loading").innerHTML = "";
    document.querySelector("button").disabled = false;
    alert("Error koneksi ke server. Pastikan Web App sudah di-deploy dengan akses 'Anyone'.");
    console.error(err);
  });
}

// ===============================
// REFRESH DATA
// ===============================
function refreshData() {
  loadData();
}

// ===============================
// INITIAL LOAD
// ===============================
document.addEventListener("DOMContentLoaded", loadData);

</script>

</body>
</html>
